# PDF Security Configuration Guide

## Overview

The PDF signing system includes comprehensive security checks to prevent malicious content while allowing legitimate academic documents. This guide explains the security configuration and troubleshooting options.

## Security Features

### ✅ What's Protected Against
- **JavaScript exploits** (eval functions, auto-executing scripts)
- **External file access** (launching files, importing data)
- **Malicious form submissions** (forms that submit to external URLs)
- **Oversized files** (DoS prevention)
- **Corrupted PDFs** (integrity validation)

### ✅ What's Allowed
- **Standard PDF features** (links, annotations, basic forms)
- **Academic content** (LaTeX-generated PDFs, Word exports)
- **Embedded metadata** (required for digital signatures)
- **Complex documents** (up to 100MB, 1000 pages, 50k objects)

## Configuration Options

### Environment Variables (.env)

```bash
# Disable PDF cleaning entirely (for testing)
DISABLE_PDF_CLEANING=false

# Allow uncleaned PDFs to proceed (bypass security for legitimate files)
ALLOW_UNCLEANED_PDFS=false

# Skip security checks entirely (not recommended for production)
SKIP_PDF_SECURITY_CHECKS=false

# XAdES digital signatures
XADES_ENABLED=true
```

### Code Configuration (SignatureController.php)

```php
// PDF cleaning limits (can be adjusted)
'max_file_size' => 100 * 1024 * 1024,  // 100MB
'max_pages' => 1000,                    // 1000 pages
'max_objects' => 50000,                 // 50k PDF objects

// Security checks
'security_checks' => [
    'check_javascript' => true,         // Check for dangerous JS
    'check_forms' => false,             // Allow forms (academic PDFs)
    'check_external_refs' => true,      // Check external references
    'check_embedded_files' => false,    // Allow embedded files
],
```

## Troubleshooting PDF Upload Issues

### Error: "File mengandung konten yang berpotensi berbahaya"

**Quick Fix:**
1. Add to `.env`: `ALLOW_UNCLEANED_PDFS=true`
2. Restart your web server
3. Try uploading again

**Permanent Solution:**
1. Check the logs for the specific pattern that triggered the error
2. If it's a false positive, the security patterns can be adjusted
3. Contact administrator to review the specific PDF

### Error: "File terlalu besar/kompleks"

**Solutions:**
1. Reduce PDF file size (compress images, remove unnecessary content)
2. Or increase limits in `PDF_CLEANING_CONFIG`
3. Or temporarily set `ALLOW_UNCLEANED_PDFS=true`

### Error: "Gagal membersihkan PDF"

This usually means the PDF has compatibility issues with the cleaning process.

**Quick Fix:**
```bash
# In .env file
ALLOW_UNCLEANED_PDFS=true
```

**Alternative:**
```bash
# Disable cleaning entirely
DISABLE_PDF_CLEANING=true
```

## Security Modes

### 1. **Production Mode** (Default)
- Full security checks enabled
- PDF cleaning/sanitization active
- No bypasses allowed

### 2. **Development Mode**
```bash
ALLOW_UNCLEANED_PDFS=true
```
- Security checks run but don't block uploads
- Useful for testing with various PDF formats

### 3. **Testing Mode**
```bash
DISABLE_PDF_CLEANING=true
ALLOW_UNCLEANED_PDFS=true
```
- Minimal security for development/testing
- **NOT recommended for production**

## Monitoring & Logs

### Important Log Entries
- `"PDF cleaning failed"` - Security issue or compatibility problem
- `"Suspicious content found"` - Potential security threat detected
- `"PDF successfully cleaned"` - Document processed safely

### Check Logs
```bash
# Laravel logs
tail -f storage/logs/laravel.log | grep -i "pdf\|clean\|security"

# Filter for PDF-related entries
grep -i "pdf\|suspicious\|xades" storage/logs/laravel.log
```

## When to Adjust Security

### ✅ Safe to Allow Uncleaned PDFs:
- Internal thesis documents from trusted sources
- PDFs generated by known academic tools (LaTeX, Word)
- Documents that fail cleaning but are verified as safe

### ❌ Never Allow Uncleaned PDFs:
- User-uploaded documents from unknown sources
- PDFs from external/public submissions
- Files that trigger multiple security warnings

## XAdES Digital Signatures

The system also includes XAdES (XML Advanced Electronic Signatures) for the embedded metadata:

### Setup Required
```bash
# Generate keys
php artisan xades:generate-keys

# Verify setup
php artisan xades:verify-setup
```

### Configuration
```bash
# Enable/disable in .env
XADES_ENABLED=true
```

## Emergency Bypass

If you need to bypass all PDF security temporarily (for urgent situations):

```bash
# In .env - USE WITH EXTREME CAUTION
DISABLE_PDF_CLEANING=true
ALLOW_UNCLEANED_PDFS=true
SKIP_PDF_SECURITY_CHECKS=true
```

**⚠️ Important:** Revert these settings immediately after resolving the issue.

## Contact

For security-related issues or to report false positives, contact the system administrator with:
1. The specific error message
2. Information about the PDF source (LaTeX, Word, etc.)
3. Log entries showing the triggered security pattern 